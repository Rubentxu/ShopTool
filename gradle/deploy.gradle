def defaulSshKeyFile = "${System.properties['user.home']}/.ssh/${config['server.fileRsa']}"

sshOptions {
    trustUnknownHosts = true
    verbose = true
    defaultPassword = ""
    defaultKeyFile = new File(defaulSshKeyFile)
    defaultPassPhrase = ""

    execOptions {
        showOutput = true
        failOnError = true
        succeedOnExitStatus = 0
        maxWait = 30000
    }
}


task deployShopTool {
    description "Instalacion de ShopTool"
    doLast {
        println "************************************************************************************"
        println "directorio ssh $defaulSshKeyFile"
        println "comando ssh  ${config['server.user']}@${config['server.host']}:${config['server.port']}"

        remoteSession {
            host = config['server.host']
            user = config['server.user']
            port = config['server.port']

            def result = exec(command: '[ -f /lib/systemd/system/shoptool.service ] && echo "Found" || echo "Not found"'
                               , failOnError: false, showOutput: true)
            if (result.exitStatus == 1) {
              result.output.eachLine { line ->
                if (line.contains('Not found')) {
                  exec "useradd shoptool -s /sbin/nologin -M"
                  scp {
                    from { localFile "gradle/shoptool.service" }
                    into { remoteFile '/lib/systemd/system/shoptool.service' }
                  }
                  exec "chmod 755 /lib/systemd/system/shoptool.service"
                  exec "systemctl enable shoptool.service"
                }
                scp {
                  from { localDir "build/" }
                  into { remoteDir '/home/shoptool' }
                }
                exec "systemctl restart shoptool.service"
              }
            }
        }
    }
}

deployShopTool.dependsOn build


